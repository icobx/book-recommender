<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Book Recommender</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 2em;
      }
      input,
      button {
        padding: 0.5em;
        margin-right: 0.5em;
      }
    </style>
  </head>
  <body>
    <h1>Book Recommender</h1>
    <input type="number" id="topN" value="5" min="1" />

    <!-- <label for="book">Book title:</label> -->
    <input
      list="book-options"
      id="bookTitle"
      name="book"
      oninput="fetchSuggestions(this.value)"
    />
    <datalist id="book-options"></datalist>

    <!-- <input type="text" id="bookTitle" placeholder="Enter a book title" /> -->
    <button onclick="recommend()">Recommend</button>

    <h2>Results:</h2>
    <ul id="results"></ul>
    <script>
      const fetchSuggestions = async (query) => {
        if (query.length < 3) return;

        const dataList = document.getElementById("book-options");

        try {
          const response = await fetch(
            `http://localhost:8000/autocomplete?q=${encodeURIComponent(query)}`
          );
          const data = await response.json();

          dataList.innerHTML = "";
          data.suggestions.forEach((title) => {
            const option = document.createElement("option");
            option.value = title;
            dataList.appendChild(option);
          });
        } catch (error) {
          console.log("Fetch failed: ", error);
        }
      };

      async function recommend() {
        const bookTitle = document.getElementById("bookTitle").value;
        const topN = document.getElementById("topN").value;

        const response = await fetch("http://localhost:8000/recommend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            book_title: bookTitle,
            top_n: parseInt(topN),
          }),
        });
        console.log(response);
        if (!response.ok) {
          console.log("LOLOLOLO");
          // Response has status code >= 400
          const error = await response.json(); // or text() if not JSON
          console.error("Server error:", error);
          alert(`Error: ${error.detail || "Unknown error"}`);
          return;
        }
        const data = await response.json();
        const resultsList = document.getElementById("results");
        resultsList.innerHTML = "";

        data.recommended_books.forEach((book) => {
          const li = document.createElement("li");
          li.textContent = `${
            book.book_title
          } (corr: ${book.correlation_with_selected_book.toFixed(2)}, rating: ${
            book.average_rating
          })`;
          resultsList.appendChild(li);
        });
      }
    </script>
  </body>
</html>
